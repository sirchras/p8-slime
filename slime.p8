pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
#include vector.p8

entities = {}

function _init()
	player = newentity{
		x = 60, y = 60,
		sprite = newsprite(1),
		control = playercontrolcmp(),
		physics = playerphysicscmp(),
	}
	--todo: move these somewhere more sensible - prob components?
	--max speed, acceleration props
	player.acc = 0.2
	player.maxspeed = 2
	--friction, gravity forces
	player.f = 0.1 --%loss of momentum
	player.g = 0.2
	--jump force
	player.jumpf = 3.6
	player.grounded = false
end

function _update()
	controlsys.update()
	physicsys.update()
end

function _draw()
	--
	pal()
	cls()
	-- map as an entity?
	map() --todo: should change this
	rendersys.update()
end

function issolid(cel)
	return fget(mget(cel.x, cel.y), 0)
end

--these fns might be superfluous
-- get map cell of world coords
function cel(v)
	return vector(flr(v.x / 8), flr(v.y / 8))
end

-- get world pos of map cell coords
function wld(v)
	return v * 8
end

--entities:
entity = {}
entity.__index = entity
function newentity(arg)
	local ent = {
		pos = vector(arg.x or 0, arg.y or 0),
		v = vector(arg.dx or 0, arg.dy or 0),
		w = arg.w or 8,
		h = arg.h or arg.w or 8,
		-- sprite = arg.sprite,
		-- control = arg.control,
		-- physics = arg.physics,
	}
	setmetatable(ent, entity)
	ent.sprite = arg.sprite
	ent.control = arg.control
	ent.physics = arg.physics
	--could add to different entity tables for optimization
	return add(entities, ent)
end

-- components: sprite, input/control
function newsprite(i)
	local sp = {
		-- might be worth transitioning to using sspr (and sprite coords)
		i = i or 0,
		flip = false,
	}
	return sp
end

--passing the entity in as self to the control.update fn feels
-- a little jank right now, will see if there's a better way idk...
function playercontrolcmp()
	local control = {}
	control.update = function(self)
		local v, acc = self.v, self.acc
		if btn(‚¨ÖÔ∏è) then
			v.x -= acc
			self.sprite.flip = true
		end
		if btn(‚û°Ô∏è) then
			v.x += acc
			self.sprite.flip = false
		end
		--limit horizontal velocity to maxspeed
		if abs(v.x) > self.maxspeed then
			v.x = sgn(v.x) * self.maxspeed
		end
		--jump
		if self.grounded and (btnp(‚¨ÜÔ∏è) or btnp(‚ùé) or btnp(üÖæÔ∏è)) then
			--apply up force to v.y
			v.y = -self.jumpf
			self.grounded = false
		end
		self.v = v
	end
	return control
end

--todo: map collisions (ground/wall),
function playerphysicscmp()
	local physics = {}
	physics.update = function(self)
		local pos, v = self.pos, self.v
		--friction (todo: different friction in air?)
		v.x *= (1 - self.f)
		if abs(v.x) < 0.015 then v.x = 0 end
		--acc by gravity
		v.y += self.g
		--update pos
		pos += v

		--map collisions
		--down:
		self.grounded = false --assume falling until confirmed otherwise
		if v.y > 0 then
			local down = pos + vector(self.w / 2, self.h)
			-- local t = down + v
			if issolid(cel(down)) then
				pos.y = flr(pos.y / 8) * 8
				v.y = 0
				self.grounded = true
			end
		end
		--left/right
		local offset = v.x < 0 and 0 or self.w
		local side = pos + vector(offset, 0)
		if issolid(cel(side)) then
			pos.x = (flr(pos.x / 8) * 8) + (self.w - offset)
			-- v.x = 0
		end
		--up
		if v.y < 0 then
			local up = pos + vector(self.w / 2, 0)
			if issolid(cel(up)) then
				pos.y = flr(pos.y / 8)* 8 + self.h
				v.y = 0
			end
		end

		--update ent props
		self.pos, self.v = pos, v
	end
	return physics
end

--systems: contol, physics
controlsys = {}
controlsys.update = function()
	for ent in all(entities) do
		if not ent.control then goto continue end
		ent.control.update(ent)
		::continue::
	end
end

physicsys = {}
physicsys.update = function(self)
	for ent in all(entities) do
		if not ent.physics then goto continue end
		ent.physics.update(ent)
		::continue::
	end
end

rendersys = {}
rendersys.update = function()
	for ent in all(entities) do
		if not ent.sprite then goto continue end
		palt(0, false)
		palt(1, true)
		spr(ent.sprite.i, ent.pos.x, ent.pos.y, 1, 1, ent.sprite.flip)
		::continue::
	end
end

__gfx__
000000001111111111bbbb111111111111111111000000000000000000bbbb000000000000000000000000000000000000000000000000000000700000000000
0000000011bbbb111b0000b111bbbb11111111110000000000bbbb000bbbbbb000bbbb0000000000000000000000000000007000000070000000000000000000
007007001b0000b1b000000b1b0000b111bbbb11000000000bbbbbb0bbbbbbbb0bbbbbb000bbbb00000000000007700707077000000077000000770000000000
00077000b000000bb00b0b0bb000000b1b0000b100000000bbbbbbbbbbb0b0bbbbbbbbbb0bbbbbb0000000000707770000077700000777000007770700000000
00077000b00b0b0bb000000bb00b0b0bb000000b00000000bbb0b0bbbbbbbbbbbbb0b0bbbbbbbbbb000000000077777000777770007777700077777000000000
00700700b000000bb000000bb000000bb00b0b0b00000000bbbbbbbbbbbbbbbbbbbbbbbbbbb0b0bb000000000070707000707070007070700070707000000000
00000000b000000b1b0000b1b000000bb000000b00000000bbbbbbbb0bbbbbb0bbbbbbbbbbbbbbbb000000000077777000777770007777700077777000000000
000000001bbbbbb111bbbb111bbbbbb1bbbbbbbb000000000bbbbbb000bbbb000bbbbbb0bbbbbbbb000000000007770000077700000777000007770000000000
00000000000000000077700000000000000000000000000000000000007770000000000000000000000000000000000000000000000000000000000000000000
00000000007777000700070000777700000000000000000000777700077777000077770000000000000000000000000000700000070000000000000000000000
00000000070000707000007007000070007777000000000007777770777777700777777000777700000000000007700000077000000770000007700000000000
00000000700000077070707070000007070000700000000077777777770707707777777707777770000000000707770070077700000777000007770000000000
00000000700707077000007070070707700000070000000077707077777777707770707777777777000000000077777000777770007777700077777000000000
00000000700000077000007070000007700707070000000077777777777777707777777777707077000000000077070000770700007707000077070000000000
00000000700000077000007070000007700000070000000077777777777777707777777777777777000000000077777000777770007777700077777000000000
00000000777777707777770077777770777777700000000077777770777777007777777077777770000000000007770000077700000777000007770000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007777000000000000000000000000000000000000777700000000000000000000000000000000000000000000000000000000000000000000000000
00000000070000700000000000000000000000000000000007777770000000000000000000000000000000000000700000000000000000000000000000000000
00000000700000070077770000000000000000000000000077777777007777000000000000000000000000000007770000007000000000000000000000000000
00000000700000070700007000000000000000000000000077777777077777700000000000000000000000000077777000077700000000000000000000000000
00000000700000077000000707777770000000000000000077777777777777770777777000000000000000000070707000707070000070000000000000000000
00000000700000077000000770000007000000000000000077777777777777777777777700000000000000000077777000777770000777000000000000000000
00000000077777707777777777777777077777700000000007777770777777777777777707777770000000000007770000077700000777000000700000000000
00000000000000000077770000777700007777000000000000000000007777000077770000777700000000000000000000000000000000000000000000000000
00000000007777000700007007000070070000700000000000777700077777700777777007777770000000000000000000000000000000000000000000000000
00000000070000707000000770000007070000700000000007777770777777777777777707777770000000000000000000000000000000000000000000000000
00000000700000077007070770070707700000070000000077777777777070777770707777777777000000000000000000000000000000000000000000000000
00000000700707077000000770000007700707070000000077707077777777777777777777707077000000000000000000000000000000000000000000000000
00000000700000070700007007000070700000070000000077777777077777700777777077777777000000000000000000000000000000000000000000000000
00000000700000070070070000777700070000700000000077777777007777000077770007777770000000000000000000000000000000000000000000000000
00000000077777700007700000000000007777000000000007777770000770000000000000777700000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dddd0000000000
00000000000000000000000000000000000000000000000000000000000000000000000000aaa00000aaa00000aaa00000aaa00000000000000dd00000000000
0000000000000000000000000000000000000000000000000000000000000000000000000a000a000a000a000a000a000aaa0a000000000000d00d0000000000
0000000000000000000000000000000000000000000000000000000000000000000000000a0a0a000a0a0a000a0aaa000aaa0a00000000000d0000d000000000
0000000000000000000000000000000000000000000000000000000000000000000000000a0a0a000a0aaa000aaaaa000a0a0a00000000000d0000d000000000
0000000000000000000000000000000000000000000000000000000000000000000000000a000a000a0aaa000aaa0a000a000a00000000000d0000d000000000
00000000000000000000000000000000000000000000000000000000000000000000000000aaa00000aaa00000aaa00000aaa000000000000d0000d000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dddd0000000000
00000000000000000000000000000000000000000444444000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000b0000000b0000000000000444444040000004000000000000000000000000000aa000000aa000000aa000000aa000000000000000000000000000
0000000000bbb00000b0b0000000000040000004400aa00400000000000000000000000000a00a0000a00a0000a00a0000aaaa00000000000000000000000000
000000000bbbbb000b000b0000000000400000044444444400000000000000000000000000a00a0000a00a0000a0aa0000aa0a00000000000000000000000000
000000000bbbbb000b000b0000000000400aa0044000000400000000aaa000000000000000a00a0000a00a0000aaaa0000a00a00000000000000000000000000
0000000000bbb00000bbb00000000000444444444444444400000000a0aaaaaa0000000000a00a0000a0aa0000aa0a0000a00a00000000000000000000000000
00000000000000000000000000000000400000044000000400000000aaa00a0a00000000000aa000000aa000000aa000000aa000000000000000000000000000
00000000000000000000000000000000444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dddddd000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d0d00d0d00000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d0d00d0d00000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d0d00d0d00000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dcdccdcd00000000
00000000dddd0ddd0000000044444444444444444444444400000000444444440000000000000000000000000444444004444440000000000000000000000000
00000000dddd0ddd0000000004000000000000000000004000000000440000440000000000000000000000004040040440000004000000000000000000000000
00000000000000000000000040000000000000000000000400000000404004040000000000000000000000004040040440000004000000000000000000000000
00000000dd0ddd0d0000000000000000000000000000000000000000400400040000000000000000000000004040040440000004000000000000000000000000
00000000dd0ddd0d0000000000000000000000000000000000000000400040040000000000600060000000005555040440000004000000000000000000000000
00000000000000000000000000000000000000000000000000000000404004040000000006060606000000005005040440000004000000000000000000000000
00000000000000000000000000000000000000000000000000000000440000440000000006060606000000005555040440000004000000000000000000000000
00000000000000000000000000000000000000000000000000000000444444440000000006060606000000004040040440000004000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077700000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccc00077777
00000000000030000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000003030300303000000030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000333000033000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ddddd0dddd0ddddddd0ddddd000000000000000000ddd000000000000000000070000007700000077000000770000007000000000000000000000000
00000000ddddd0dddd0ddddddd0ddddd000000000000000000ddd000000000000000000070000007700000077000000777777777000000000000000000000000
00000000dd00000000000000000000dd000000000000000000000000000000000000000070000007700000077000000770000007000000000000000000000000
00000000dd0ddddd0ddd0ddd0dddd0dd00000000000dddd0ddd0ddd0ddddd0000000000070000007700000077000000770000007000000000000000770000000
00000000dd0ddddd0ddd0ddd0dddd0dd00000000000dddd0ddd0ddd0ddddd0000000000077777777700000077000000770000007000000007777777007777777
00000000000dd00000000000000dd00000000000000dd00000000000000dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd0dd000000ddd00000dd0dd00000000000dd0ddddddd0dddd0dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd000000000ddd00000dd0dd00000000000dd0ddddddd0dddd0000000000000070000007777777777000000770000007000000000000000000000000
00000000dd0dd00000000000000000dd00000000000000dd00000000dd0dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd0dd00000000000000dd0dd00000000000dd0dd00000000dd0dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd0dd0dd00000000000dd00000000000000dd00000000000dd0dd0dd0000000070000007700000077777777770000007000000000000000000000000
00000000dd0000dd00000000dd0dd0dd00000000dd0dd0dd00000000dd0000dd0000000070000007700000077000000770000007000000000000007000000777
00000000dd0dd0dd00000000dd0000dd00000000dd0000dd00000000dd0dd0dd0000000070000007700000077000000770000007000000007777770777777000
00000000000dd00000000000dd0dd0dd00000000dd0dd0dd00000000000dd0000000000070000007700000077000000777777777000000000000000000000000
00000000dd0dd00000000000000dd0dd00000000000dd0dd00000000dd0dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd00000000000000000dd0dd00000000000dd0dd00000000dd0000000000000070000007700000077000000770000007000000000000000000000000
00000000dd0dd00000ddd000000000dd00000000000000dddd0ddddddd0dd0000000000077777777700000077000000770000007000000000000000000000000
00000000dd0dd00000ddd000000dd0dd00000000000dd0dddd0ddddddd0dd0000000000070000007700000077000000770000007000000000000000000000000
00000000000dd00000000000000dd00000000000000dd00000000000000dd0000000000070000007700000077000000770000007000000000000000000000000
00000000dd0dddd0ddd0ddd0ddddd0dd00000000000ddddd0ddd0ddd0dddd0000000000070000007777777777000000770000007000000000000000007777000
00000000dd0dddd0ddd0ddd0ddddd0dd00000000000ddddd0ddd0ddd0dddd0000000000070000007700000077000000770000007000000007777777770000777
00000000dd00000000000000000000dd000000000000000000000000000000000000000070000007700000077000000770000007000000000000000000000000
00000000ddddd0ddddddd0dddd0ddddd0000000000000000000ddd00000000000000000070000007700000077777777770000007000000000000000000000000
00000000ddddd0ddddddd0dddd0ddddd0000000000000000000ddd00000000000000000070000007700000077000000770000007000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000
0000000000000000000000000000000000010101000001000000000000000000000100010001000100000000000000000001010100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
9596969696969696969696969696969696969697000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5000000000000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5000000000000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5000079790000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b5b692b6b69300000000000000009192929292b7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000a50000000000000000a70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
95b2b2b2b2b30000000000000000b1b2b2b2b297000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5000000000000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5000000000000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a54e0000000081000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5710000000091929292929292930000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a50000000000a7000000000000a57374747475a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a50000000071b1b2b2b2b2b2b2b30000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a500000000000000006e000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a5710000000000000000000000000000000000a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a50083000000000000000000000077007b0082a7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b5b6b6b6b6938e8e8e8e8e8e8e8e91b6b6b6b6b7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000a50000000000000000a70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
